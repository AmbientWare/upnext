name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Check admin permission
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/${{ github.actor }}/permission --jq '.permission')
          if [[ "$PERMISSION" != "admin" ]]; then
            echo "::error::Only repository admins can bump the version."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install bun
        uses: oven-sh/setup-bun@v2

      - name: Bump version
        run: |
          python - <<'SCRIPT'
          import re, pathlib

          bump = "${{ inputs.bump }}"

          # --- Read current version from the single source of truth ---
          version_file = pathlib.Path("packages/shared/src/shared/_version.py")
          text = version_file.read_text()
          match = re.search(r'__version__\s*=\s*"(\d+\.\d+\.\d+)"', text)
          if not match:
              raise SystemExit("Could not parse version from _version.py")
          major, minor, patch = (int(x) for x in match.group(1).split("."))

          # --- Bump ---
          if bump == "major":
              major, minor, patch = major + 1, 0, 0
          elif bump == "minor":
              minor, patch = minor + 1, 0
          else:
              patch += 1
          new_version = f"{major}.{minor}.{patch}"

          # --- Update _version.py ---
          version_file.write_text(f'__version__ = "{new_version}"\n')

          # --- Update root pyproject.toml ---
          pyproject = pathlib.Path("pyproject.toml")
          pyproject.write_text(
              re.sub(
                  r'^version\s*=\s*".*"',
                  f'version = "{new_version}"',
                  pyproject.read_text(),
                  count=1,
                  flags=re.MULTILINE,
              )
          )

          print(f"Bumped version to {new_version}")
          SCRIPT

      - name: Regenerate lockfile
        run: uv lock

      - name: Read new version
        id: version
        run: |
          VERSION=$(python -c "import re, pathlib; print(re.search(r'__version__\s*=\s*\"(.+?)\"', pathlib.Path('packages/shared/src/shared/_version.py').read_text()).group(1))")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/shared/src/shared/_version.py pyproject.toml uv.lock
          git commit -m "bump version to v${{ steps.version.outputs.version }}"
          git push

      - name: Build and publish packages
        run: bash scripts/release-packages.sh -r all --build-only

      - name: Publish shared
        run: uv publish --check-url https://pypi.org/simple packages/shared/dist/*

      - name: Publish server
        run: uv publish --check-url https://pypi.org/simple packages/server/dist/*

      - name: Publish upnext
        run: uv publish --check-url https://pypi.org/simple packages/upnext/dist/*

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: gh release create "v${{ steps.version.outputs.version }}" --generate-notes --title "v${{ steps.version.outputs.version }}"
